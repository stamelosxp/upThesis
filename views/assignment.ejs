<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title><%= pageTitle %> | upThesis</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/flatpickr@4.6.13/dist/l10n/gr.js"></script>


    <link rel="stylesheet" href="/styles/assignment.css"/>
    <script type="module" src="/scripts/assignment.js" defer></script>
</head>
<body>
<%- include('includes/main-header') %>
<div class="layout">
    <%- include('includes/main-menu') %>
    <main>
        <% if (locals.connectedUserRole !== 'student') { %>
            <section class="back-section">
                <a href="/assignments">
                    <img
                            class="back-icon"
                            src="/icons/back_arrow.png"
                            alt="Back Icon"
                    />
                    <span class="back-icon-text">Πίσω στις Αναθέσεις</span>
                </a>
            </section>
        <% } %>

        <div class="assignment-header">

            <div class="title-status-container">
                <h2><%= thesis.title %></h2>
                <%- include('includes/assignment-status-badge', {assignment: thesis}) %>
            </div>

            <%
            let showEvaluation = false;
            if (thesis.presentationDate) {
                const _pres = new Date(thesis.presentationDate);
                if (!isNaN(_pres) && _pres.getTime() <= Date.now()) {
                    showEvaluation = true;
                }
            }
            let canCancel = false;
            if (thesis.officialAssignmentDate) {
                const _cancelProf = new Date(thesis.officialAssignmentDate);
                if (!isNaN(_cancelProf)) {
                    const now = new Date();
                    const twoYearsMs = 2 * 365 * 24 * 60 * 60 * 1000;
                    if (now.getTime() - _cancelProf.getTime() >= twoYearsMs) {
                        canCancel = true;
                    }
                }
            }
            %>

            <% function currentEvent() {
                if (userThesisRole === 'supervisor') {
                    if (!thesis.protocolNumberAssignment && (thesis.status === 'active' || thesis.status === 'pending')) {
                        return 'cancel_pending_assignment';
                    } else if (thesis.status === 'active' && thesis.protocolNumberAssignment) {
                        return 'cancel_active_assignment';
                    } else if (thesis.status === 'review' && thesis.temporaryReportFile && !showEvaluation) {
                        return 'presentation_assignment';
                    }
                } else if (userThesisRole === 'student') {
                    if (thesis.status === 'review' && thesis.temporaryReportFile && !showEvaluation) {
                        return 'presentation_assignment';
                    } else if (thesis.status === 'review' && !thesis.temporaryReportFile && !showEvaluation) {
                        return 'dynamic_button';
                    }
                } else if (userThesisRole === 'secretary') {
                    if (thesis.status === 'active' && thesis.professors.memberA.id && thesis.professors.memberB.id && !thesis.protocolNumberAssignment) {
                        return 'official_assignment';
                    } else if (thesis.status === 'active' && thesis.protocolNumberAssignment) {
                        canCancel = true;
                        return 'cancel_active_assignment';
                    } else if (thesis.status === 'review' && thesis.finalGrade && thesis.nemertesLink) {
                        return 'complete_assignment';
                    }
                }
                return null;
            }
            %>

            <% if (currentEvent() === 'cancel_pending_assignment'){ %>
                <button class="cancel-button enabled" id="cancel-tmp-assignment-button">
                    Ακύρωση Ανάθεσης
                </button>
            <% } else if (currentEvent() === 'cancel_active_assignment') { %>
                <button class="cancel-button <%= !canCancel ? 'disabled' : '' %>" id="official-cancel-button">
                    Ακύρωση Ανάθεσης
                    <% if(userThesisRole === 'supervisor' && !canCancel) { %>
                        <span class="disable-button-message">Ακύρωσή ανάθεσης μπορεί να γίνει μετά το πέρας <strong>δυο ετών</strong> απο την επίσημη ανάθεσή.</span>
                    <% } %>
                </button>
            <% } else if (currentEvent() === 'presentation_assignment') { %>
                <button class="standard-button" id="presentation-button">
                    Παρουσίαση
                </button>

            <% } else if (currentEvent() === 'official_assignment') { %>
                <button class="standard-button" id="official-assignment-button">
                    Επίσημη Ανάθεση
                </button>
            <% } else if (currentEvent() === 'complete_assignment') { %>
                <button class="accept-button" id="complete-assignment-button">
                    Ολοκλήρωση
                </button>
            <% } else if (currentEvent() === 'dynamic_button') { %>
                <div id="dynamic-button-presentation">
                </div>
            <% } %>
        </div>

        <% if(currentEvent() && currentEvent() !== 'presentation_assignment' && currentEvent() !== 'dynamic_button'){ %>
            <%- include('includes/assignment_status_modal', { includeEvent: currentEvent(), thesis: thesis }) %>
        <% } else if(currentEvent() === 'presentation_assignment') { %>
            <%- include('includes/announcement_create_modal', { thesis: thesis }) %>
        <% } %>

        <section id="assignment-detail">
            <div class="assignment-detail-container" data-thesis-id="<%= thesis._id %>"
                 data-user-role="<%= userThesisRole %>">
                <ul class="sub-menu-assignment-details">
                    <li>
                        <a class="tab-link active" data-tab="info" href="#info">Πληροφορίες</a>
                    </li>
                    <% if (locals.connectedUserRole !== 'secretary') { %>
                        <% if(thesis.status === 'active' || thesis.status === 'review') { %>
                            <li>
                                <a class="tab-link" data-tab="notes" href="#notes">Σημειώσεις</a>
                            </li>
                            <% if (userThesisRole === 'supervisor' || userThesisRole === 'student') { %>
                                <li>
                                    <a class="tab-link" data-tab="meetings" href="#meetings">Συναντήσεις</a>
                                </li>
                            <% } %>
                            <% if(thesis.officialAssignmentDate) { %>
                                <li>
                                    <a class="tab-link" data-tab="evaluation" href="#evaluation">Αξιολόγιση</a>
                                </li>
                            <% } %>

                            <% if (thesis.status === 'review' && userThesisRole === 'supervisor' && !thesis.protocolExists) { %>
                                <li>
                                    <a class="tab-link" data-tab="protocol" href="#protocol">Πρακτικό</a>
                                </li>
                            <% } %>
                        <% } %>
                    <% } %>
                    <li>
                        <a class="tab-link" data-tab="timeline" href="#timeline">Χρονολόγιο</a>
                    </li>
                </ul>

                <div class="tab-content-area">
                    <div id="info" class="tab-content active">
                        <%- include('includes/assignment_tabs/info', { thesis: thesis, userThesisRole: userThesisRole }) %>
                    </div>
                    <% if (locals.connectedUserRole !== 'secretary') { %>
                        <% if(thesis.status === 'active' || thesis.status === 'review') { %>
                            <div id="notes" class="tab-content">
                                <%- include('includes/assignment_tabs/notes') %>
                            </div>
                            <% if (userThesisRole === 'supervisor' || userThesisRole === 'student') { %>
                                <div id="meetings" class="tab-content">
                                    <%- include('includes/assignment_tabs/meetings') %>
                                </div>
                            <% } %>
                            <% if(thesis.officialAssignmentDate) { %>
                                <div id="evaluation" class="tab-content ">
                                    <%- include('includes/assignment_tabs/evaluation', { userThesisRole: userThesisRole, thesis: thesis, showEvaluation: showEvaluation}) %>
                                </div>
                            <% } %>

                            <% if (thesis.status === 'review' && userThesisRole === 'supervisor' && !thesis.protocolExists) { %>
                                <div id="protocol" class="tab-content">
                                    <%- include('includes/assignment_tabs/grade_protocol', { thesis: thesis}) %>
                                </div>
                            <% } %>
                        <% } %>
                    <% } %>
                    <div id="timeline" class="tab-content">
                        <%- include('includes/assignment_tabs/timeline', { userThesisRole: userThesisRole, thesis: thesis}) %>
                    </div>
                </div>
            </div>


        </section>
    </main>
</div>
</body>
</html>
