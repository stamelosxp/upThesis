<%
function checkEvaluationLoad() {
    for (const key in thesis.gradesExists) {
        if (thesis.gradesExists[key] === true) {
            return 'true';
        }
    }
    return 'false';
}
%>

<div class="evaluation-content">
    <% if (thesis.status === 'active') { %>
        <% if (userThesisRole === 'supervisor') { %>
            <div class="no-data">
                <p class="simple-message">
                    Ορίστε τη διπλωματική σε Υπό-Αξιολόγηση για να ξεκινήσει η διαδικασία
                    αξιολόγησης.
                </p>
                <button class="accept-button" id="change-to-review">Ορισμός σε Υπό-Αξιολόγηση</button>
            </div>
        <% } else { %>
            <p class="no-data">Περιμένετε τον Επιβλέπων να ορίσει τη Διπλωματική Εργασία σε Υπό-Αξιολόγηση.</p>
        <% } %>
    <% } else if (thesis.status === 'review') { %>
        <div class="info-section">
            <p class="group-header">Αξιολόγηση</p>
            <div class="grades-container" data-exist-grades="<%= checkEvaluationLoad() %>">
                <% if (showEvaluation) { %>
                    <div class="mobile-navigation-table">
                        <button type="button" class="nav-arrow back-arrow" disabled> &larr;</button>
                        <span class="current-table-professor">
                            <% if (userThesisRole === 'supervisor' || userThesisRole === 'student') { %>
                                Επιβλέπων
                            <% } else if (userThesisRole === 'memberA') { %>
                                Μέλος Α
                            <% } else if (userThesisRole === 'memberB') { %>
                                Μέλος Β
                            <% } %>
                        </span>
                        <button type="button" class="nav-arrow front-arrow"> &rarr;</button>
                    </div>
                    <table class="evaluation-table">
                        <thead>
                        <tr>
                            <th>Κατηγορία</th>
                            <th class="<%= userThesisRole !== 'supervisor' ? 'hidden' : '' %>">Επιβλέπων
                            </th>
                            <th class="<%= userThesisRole !== 'memberA' ? 'hidden' : '' %>">Μέλος Α</th>
                            <th class="<%= userThesisRole !== 'memberB' ? 'hidden' : '' %>">Μέλος Β</th>
                        </tr>
                        </thead>
                        <tbody>
                        <% const categories = ["Ποιότητα", "Διάρκεια", "Κείμενο", "Παρουσίαση"]; const metricKeys = ["quality", "duration", "report", "presentation"]; %>
                        <% categories.forEach(function(category, idx) { %>
                            <% const metricKey = metricKeys[idx]; %>
                            <tr>
                                <td><%= category %></td>
                                <td class="<%= userThesisRole !== 'supervisor' ? 'hidden' : '' %>">
                                    <input type="number" min="0" max="10" step="0.1"
                                           class="evaluation-input"
                                           data-role="supervisor" data-metric="<%= metricKey %>"
                                           value="" <%= userThesisRole === 'supervisor' && !thesis.gradesExists.supervisor ? '' : 'readonly' %> />
                                </td>
                                <td class="<%= userThesisRole !== 'memberA' ? 'hidden' : '' %>">
                                    <input type="number" min="0" max="10" step="0.1"
                                           class="evaluation-input"
                                           data-role="memberA" data-metric="<%= metricKey %>"
                                           value="" <%= userThesisRole === 'memberA' && !thesis.gradesExists.memberA ? '' : 'readonly' %> />
                                </td>
                                <td class="<%= userThesisRole !== 'memberB' ? 'hidden' : '' %>">
                                    <input type="number" min="0" max="10" step="0.1"
                                           class="evaluation-input"
                                           data-role="memberB" data-metric="<%= metricKey %>"
                                           value="" <%= userThesisRole === 'memberB' && !thesis.gradesExists.memberB ? '' : 'readonly' %> />
                                </td>
                            </tr>
                        <% }); %>
                        </tbody>
                    </table>
                    <% if(!thesis.gradesExists[userThesisRole] && locals.connectedUserRole === 'professor'){ %>
                        <div class="grades-buttons-group">
                            <button id="save-grades-button" type="button" class="accept-button disabled">Αποθήκευση
                            </button>
                        </div>
                    <% } %>
                <% } else { %>
                    <div class="no-data-container">
                        <p class="no-data">
                            Το βαθμολόγιο της Διπλωματικής Εργασίας θα ενεργοποιηθεί μετά την παρουσίαση της.
                        </p>
                    </div>
                <% } %>
            </div>

            <% if (!thesis.protocolExists) { %>
                <%
                    let fileExists = false
                    let linkExists = false
                %>
                <div class="content-group tmp-file">
                    <label for="temporary-report-file" class="group-header">Πρόχειρο Αρχείο</label>
                    <% if(thesis.temporaryReportFile){ fileExists = true %>
                    <p class="group-value">
                        <a href="<%= thesis.temporaryReportFile %>"
                           class="attachment-link"
                           target="_blank">
                            <span class="attachment-icon">📄</span>
                            <span class="name-content"><%= thesis.temporaryReportFile.split('/').pop() %></span>
                            <span class="attachment-type">
                            <%= thesis.temporaryReportFile.split('.').pop().toUpperCase() %>
                        </span>
                        </a>
                    </p>
                    <% } else { %>
                        <% if (userThesisRole !== 'student') { %>
                            <p class="no-data">Ο φοιτητής δεν έχει αναρτήσει πρόχειρο κείμενο.</p>
                        <% } else { %>
                            <% if(showEvaluation) { %>
                                <p class="no-data">Δεν έχετε αναρτήσει πρόχειρο κείμενο.</p>
                            <% } else { %>
                                <input
                                        type="file"
                                        id="temporary-report-file"
                                        accept=".pdf,.doc,.docx,.txt"
                                        class="file-input"
                                        placeholder="Επιλέξτε Αρχείο"
                                />
                            <% } %>

                        <% } %>
                    <% } %>

                </div>

                <div class="content-group links">
                    <p class="group-header">Πρόσθετοι Σύνδεσμοι</p>
                    <% if (thesis.temporaryLinks && thesis.temporaryLinks.length > 0) { linkExists = true %>
                    <ul class="links-list">
                        <% thesis.temporaryLinks.forEach(function(l){ if(l){ const trimmed = l.trim(); const displayName = trimmed.split('?')[0].split('#')[0].split('/').filter(Boolean).pop() || trimmed; %>
                        <li class="group-value">
                            <a href="<%= normalizeUrl(trimmed) %>" class="attachment-link" target="_blank">
                                <span class="attachment-icon" title="Link">📎</span>
                                <span class="name-content"><%= displayName %></span>
                                <span class="attachment-type">LINK</span>
                            </a>
                        </li>
                        <% } }); %>
                    </ul>
                    <% } else { %>
                        <% if (userThesisRole !== 'student') { %>
                            <p class="no-data">Ο φοιτητής δεν έχει αναρτήσει πρόσθετους συνδέσμους.</p>
                        <% } else { %>
                            <% if(showEvaluation) { %>
                                <p class="no-data">Δεν έχετε αναρτήσει πρόσθετους συνδέσμους.</p>
                            <% } else { %>
                                <div class="student-add-links">
                                    <div class="added-link-inputs">
                                    </div>
                                    <div class="link-buttons-group">
                                        <button type="button" class="nav-arrow add-link-input">+</button>
                                        <button type="button" class="nav-arrow remove-link-input" disabled>-</button>
                                    </div>
                                </div>
                            <% } %>
                        <% } %>
                    <% } %>
                </div>
                <% if(userThesisRole === 'student' && (!fileExists || !linkExists) && !showEvaluation) { %>
                    <div class="grades-buttons-group">
                        <button type="button" class="accept-button disabled" id="student-upload-button">Αποθήκευση
                        </button>
                    </div>
                <% } %>
            <% } else { %>
                <div class="content-group">
                    <label for="nemertes-link-input" class="group-header">Νημέρτης <span class="warning-message"></span></label>

                    <% if(thesis.nemertesLink) { %>
                        <% const trimmed = String(thesis.nemertesLink).trim(); if (trimmed) { const displayName = trimmed.split('?')[0].split('#')[0].split('/').filter(Boolean).pop() || trimmed; %>
                        <p class="group-value">
                            <a href="<%= normalizeUrl(thesis.nemertesLink) %>" class="attachment-link" target="_blank">
                                <span class="attachment-icon" title="Link">📎</span>
                                <span class="name-content">Νημέρτης</span>
                                <span class="attachment-type">LINK</span>
                            </a>
                        </p>
                        <% } %>
                    <% } else { %>
                        <% if (userThesisRole !== 'student') { %>
                            <p class="no-data">Ο φοιτητής δεν έχει αναρτήσει το σύνδεσμου το αποθετηρίου Νημέρτης.</p>
                        <% } else { %>
                            <input
                                    type="url"
                                    id="nemertes-link-input"
                                    class="link-input-field"
                                    placeholder="Προσθήκη συνδέσμου"
                                    data-original-value=""
                            >
                            <div class="grades-buttons-group">
                                <button type="button" class="accept-button disabled" id="nemertes-upload-button">Αποθήκευση
                                </button>
                            </div>
                        <% } %>
                    <% } %>
                </div>

            <% } %>

        </div>
    <% } %>
</div>

<%
function normalizeUrl(url) {
    if (!/^https?:\/\//i.test(url)) {
        return 'https://' + url; // default to https
    }
    return url;
}
%>